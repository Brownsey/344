---
title: "Clustering"
output: html_notebook
---

```{r setup and import data}

library(tidyverse)
library(tibble)
library(lubridate)
library(GGally)
library(cluster)
library(VIM)
library(fpc)
library(tidyr)
library(dplyr)
library(knitr)
library(ggplot2)
library(rio)
library(factoextra)
library(FactoMineR)
library(BBmisc)
library(pvclust)
library(NbClust)

import <- read_csv("inst/edited_spotify.csv")

```

```{r clean and split data}

spotify <- import %>%
  mutate(AlbumReleaseDate = parse_date_time(AlbumReleaseDate, orders = c("y", "ym","ymd"))) %>%
  #Old-school grepl method
  mutate(Artist = ifelse(grepl("Beyonc*", Artist), 'Beyonce', Artist)) %>%
  #Tidyverse str_detect method
  mutate(Artist = ifelse(Artist %>% 
                           str_detect("Janelle Mon*"), 'Janelle Monae', Artist)) %>%
  mutate(AlbumBestChartPosition = ifelse(AlbumBestChartPosition %>% 
                           str_detect("#N/A"), 0, AlbumBestChartPosition)) %>%
  na.omit() %>%
  mutate(id = row_number()) %>%
  mutate(id = as.character(id))
sapply(data, class)

test_data <- subset(spotify, ((AlbumName == "A Girl Called Dusty") | 
                                 (AlbumName == "Action!") |
                                 (AlbumName == "Selling England By The Pound") |
                                 (AlbumName == "Carpenters") | 
                                 (AlbumName == "Ride On") |
                                 (AlbumName == "Autoamerican") |
                                 (AlbumName == "Selected Ambient Works 85-92") |    
                                 (AlbumName == "Different Class") |
                                 (AlbumName == "O") |
                                 (AlbumName == "The Elder Scrolls IV: Oblivion: Original Game Soundtrack") |
                                 (AlbumName == "AM") |
                                 (AlbumName == "An Awesome Wave")))

training_data <- subset(spotify, ((AlbumName != "A Girl Called Dusty") & 
                                     (AlbumName != "Action!") &
                                     (AlbumName != "Selling England By The Pound") &
                                     (AlbumName != "Carpenters") & 
                                     (AlbumName != "Ride On") &
                                     (AlbumName != "Autoamerican") &
                                     (AlbumName != "Selected Ambient Works 85-92") &    
                                     (AlbumName != "Different Class") &
                                     (AlbumName != "O") &
                                     (AlbumName != "The Elder Scrolls IV: Oblivion: Original Game Soundtrack") &
                                     (AlbumName != "AM") &
                                     (AlbumName != "An Awesome Wave")))

```

```{r find genres}

genres <- mutate(training_data, ArtistGenres = strsplit(ArtistGenres, ","))$ArtistGenres %>% 
  unlist() %>% unique() %>% na.omit()

split_genres <- NULL

for(i in 1:length(genres)) {
  split_genres[i] <- strsplit(genres[i], " ")
}

genre_words <- unlist(split_genres)

#genre_words <- replace(genre_words, (genre_words == "hip" | genre_words == "hop"), "hip-hop")

#unique_genre_words <- unique(genre_words)

cutoff_freq <- 5

most_frequent_words <- subset(as.data.frame(table(genre_words)), (Freq > cutoff_freq))

genre_freq_plot <- most_frequent_words %>% 
  ggplot(aes(x=genre_words, y=Freq)) + geom_col()

#print(genre_freq_plot)

```

```{r nomalise function}

standardize <- function(x){(x-min(x))/(max(x)-min(x))}

```

```{r clustering}

clustering_training_data <- training_data[c("TrackDuration", "TrackDanceability",
                                            "TrackEnergy", "TrackKey", "TrackLoudness",
                                            "TrackSpeechiness", "TrackAcousticness",
                                            "TrackInstrumentalness", "TrackLiveness", 
                                            "TrackValence", "TrackTempo")] %>%
  mutate(TrackDuration = standardize(TrackDuration)) %>% 
  mutate(TrackKey = standardize(TrackKey)) %>% 
  mutate(TrackLoudness = standardize(TrackLoudness)) %>%
  mutate(TrackTempo = standardize(TrackTempo))

clustered <- agnes(dist(clustering_training_data, method = "euclidian"), diss=TRUE, method = "ward")

#fviz_dend(clustered, k=12, show_labels = FALSE)

analysis_of_clusters <- NbClust(clustering_training_data, distance="euclidean", min.nc=4, max.nc=9,
                                method="ward.D2", index="all")

fviz_nbclust(analysis_of_clusters)

```

```{r compare cluster methods}

# Some of this code took ages to run so I commented it out

# matrix of methods to compare
m <- c( "average", "single", "complete", "ward")
names(m) <- c( "average", "single", "complete", "ward")

distances <- c("euclidean", "maximum", "manhattan", "canberra", "binary", "minkowski")
names(distances) <- c("euclidean", "maximum", "manhattan", "canberra", "binary", "minkowski")

#clust_comps <- matrix(nrow = length(distances), ncol = length(m), 
#                      dimnames = list(distances,m))

# function to compute coefficient
ac <- function(distance, linkage) {
  dista <- dist(clustering_training_data, method = distance)
  agnes(dista, method = linkage)$ac
}

for(i in 1:length(distances)) {
  for(j in 1:length(m)) {
    clust_comps[i,j] <- ac(distances[i], m[j])
  }
}

```

